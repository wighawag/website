<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>wighawag &middot; wighawag</title>

    <meta name="description" content="Random thoughts and works about code">

    <meta name="generator" content="Hugo 0.14" />
    <meta name="twitter:card" content="summary">
    
    <meta name="twitter:title" content="wighawag &middot; wighawag">
    <meta name="twitter:description" content="Random thoughts and works about code">

    <meta property="og:type" content="article">
    <meta property="og:title" content="wighawag &middot; wighawag">
    <meta property="og:description" content="Random thoughts and works about code">

    <link href='//fonts.googleapis.com/css?family=Source+Sans+Pro:400,700|Oxygen:400,700' rel='stylesheet' type='text/css'>
    <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/pure/0.6.0/pure-min.css">
    <!--[if lte IE 8]>
        <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/pure/0.6.0/grids-responsive-old-ie-min.css">
    <![endif]-->
    <!--[if gt IE 8]><!-->
        <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/pure/0.6.0/grids-responsive-min.css">
    <!--<![endif]-->

    <link rel="stylesheet" href="http://blog.wighawag.com//css/all.min.css">
    <link href="//maxcdn.bootstrapcdn.com/font-awesome/4.3.0/css/font-awesome.min.css" rel="stylesheet">

    <link rel="alternate" type="application/rss+xml" title="wighawag" href="http://blog.wighawag.com//index.xml" />
</head>
<body>


<div id="layout" class="pure-g">
    <div class="sidebar pure-u-1 pure-u-md-1-4">
    <div class="header">
        <hgroup>
            <h1 class="brand-title"><a href="http://blog.wighawag.com/">wighawag</a></h1>
            <h2 class="brand-tagline"> Random thoughts and works about code </h2>
        </hgroup>

        <nav class="nav">
            <ul class="nav-list">
                
                <li class="nav-item">
                    <a class="pure-button" href="https://twitter.com/wighawag"><i class="fa fa-twitter"></i> Twitter</a>
                </li>
                
                
                <li class="nav-item">
                    <a class="pure-button" href="https://github.com/wighawag "><i class="fa fa-github-alt"></i> github</a>
                </li>
                
                <li class="nav-item">
                    <a class="pure-button" href="http://blog.wighawag.com//index.xml"><i class="fa fa-rss"></i> rss</a>
                </li>
            </ul>
        </nav>
    </div>
</div>


    <div class="content pure-u-1 pure-u-md-3-4">
        <div>
            
            <div class="posts">
                
                <h1 class="content-subhead">30 Jul 2015, 08:14</h1>
                <section class="post">
                    <header class="post-header">

                        <a href="http://blog.wighawag.com/other/test/" class="post-title">test</a>

                        <p class="post-meta">
                            
                            
                        </p>
                    </header>

                    <div class="post-description">
                        <p>asdfasds</p>

                    </div>
                </section>
                
                <h1 class="content-subhead">27 Jul 2015, 11:37</h1>
                <section class="post">
                    <header class="post-header">

                        <a href="http://blog.wighawag.com/testing" class="post-title">test</a>

                        <p class="post-meta">
                            
                            
                        </p>
                    </header>

                    <div class="post-description">
                        <p>fsdfdsf</p>

                    </div>
                </section>
                
                <h1 class="content-subhead">23 Jul 2015, 10:36</h1>
                <section class="post">
                    <header class="post-header">

                        <a href="http://blog.wighawag.com/blog/2015/07/khage/" class="post-title">khage</a>

                        <p class="post-meta">
                            
                            
                        </p>
                    </header>

                    <div class="post-description">
                        <p>It has been a while again and it is time for a new post. This time again with Haxe. I was working lately on a library mainly used for games wrapping the webgl api and other browser js api into a potentially crossplatform api. The main interesting part from it was its use of a type safe wrapper arround glsl shaders.
It served me well and it was the first thing I wanted to port to my new destination : Kha.</p>

<p>I have heard of Kha before the WWX2015 but did not bother try another framework. I had already a far better idea : write my own :D</p>

<p>but this was untill I attended Robert&rsquo;s speech and dived in Kha.</p>

                    </div>
                </section>
                
                <h1 class="content-subhead">01 Dec 2014, 10:36</h1>
                <section class="post">
                    <header class="post-header">

                        <a href="http://blog.wighawag.com/blog/2014/12/hxcpp-extern/" class="post-title">Hxcpp extern</a>

                        <p class="post-meta">
                            
                            
                        </p>
                    </header>

                    <div class="post-description">
                        

<h1 id="introduction:95526b837c261f1f491370c2a19f8b5a">Introduction</h1>

<p>To show the usefulness of <a href="http://haxe.org" title="Haxe Website">Haxe</a> at my company I have been working with hxcpp to compile a demo to both native using a C++ engine and Flash using a library that match the C++ engine api.</p>

<p>I chose to use the latest haxe/hxcpp version so I can use the new extern facility provided by hxcpp. This simplify the cpp/haxe integration and allow to manipulate cpp object directly. The help from <a href="http://gamehaxe.com/" title="Hugh's website">Hugh</a> was invaluable to get my demo working.</p>

<p>If you did not see it already there is Hugh&rsquo;s  2014 haxe conference talk:</p>

<p>slides <a href="http://gamehaxe.com/2014/05/28/wwx2014-talk-hxcpp-magic/">here</a></p>

<p>video <a href="http://haxe.io/roundups/wwx/c++-magic/">here</a></p>

<p>The C++ engine I am working with takes full control of the main entry point and as such I could not use hxcpp to generate the full application binary. Instead I made use of the <code>-D static_link</code> directive so hxcpp generate a static library that is then linked to the binary generated by the engine. This is quite nice since to make the complete executable, only linking is required once the engine main and hxcpp have done its job. This also means only hxcpp need to compile once the engine main has been compiled.</p>

<p>There are quite few engine that take control of the main entry point like that and this is due to the way each platform manage an app (IOS/Android&hellip;). So hopefully this article might help you integrate haxe with your engine.
In any case most of the thing I will talk about it here apply as well to other projects where hxcpp generate the app directly (you can skip the C++ to Haxe section as you might not need it at all in that case though).</p>

<p>For this article I cannot show any of the engine code but basically to create a game in this engine you have the possibility to implement the required virtual function from a specific C++ abstract class. These functions are the entry points to your game specific code. There is a function for init(), one for update() and some more for events like touch events and resize and few other stuff. From there you can instantiate all the required cpp classes or services &hellip;</p>

<p>Since I cannot show you the C++ engine code I set up some c++ code that act in a similar fashion. I did not bother creating an abstract class but as you can guess it will work as well with such setup.</p>

<h1 id="requirements:95526b837c261f1f491370c2a19f8b5a">Requirements</h1>

<p>Before starting you will need to setup your development environment. This require few steps as we are using bleeding edge stuff:</p>

<p>First of all you will need the latest haxe from <a href="http://build.haxe.org">http://build.haxe.org</a>
I have been using the build from 13/11/2014 :</p>

<p>for windows this is this one:</p>

<p><a href="http://hxbuilds.s3-website-us-east-1.amazonaws.com/builds/haxe/windows-installer/haxe_2014-11-13_development_6b8dff1.tar.gz">http://hxbuilds.s3-website-us-east-1.amazonaws.com/builds/haxe/windows-installer/haxe_2014-11-13_development_6b8dff1.tar.gz</a></p>

<p>You will also need the latest hxcpp from git.
I have been using the following revision :</p>

<pre><code>fb6e31af65564352060e4e4781d79f342f442161
</code></pre>

<p>While you can clone it using git itself, I recommend doing it via haxelib:</p>

<p>In order to install library hosted on a git repo  you can use the haxelib git command:</p>

<pre><code>haxelib git &lt;library-name&gt; &lt;git url&gt;
</code></pre>

<p>so for hxcpp this is the following :</p>

<pre><code>haxelib git hxcpp https://github.com/HaxeFoundation/hxcpp
</code></pre>

<p>then you can update to the revision mentioned above</p>

<p>Finally you will need to compile the haxe std library so it match your application. Normally hxcpp come with library already generated but for example for Windows since we use a specific runtime (MTd) we will need to rebuild the generated library from hxcpp
You will need first to go into the project folder of the hxcpp folder. hxcpp folder is located in the haxe library folder.
In unix system it is usually here :</p>

<pre><code> /usr/lib/haxe/lib/
</code></pre>

<p>For Windows this is normally here :</p>

<pre><code> C:\HaxeToolkit\haxe\lib\
</code></pre>

<p>so here since you want to go to the hxcpp folder installed via haxelib git and you want to go to the subfolder &ldquo;project&rdquo; you need to go at the following path:</p>

<pre><code> C:\HaxeToolkit\haxe\lib\hxcpp\git\project for windows

 /usr/lib/haxe/lib/hxcpp/git/project for unix
</code></pre>

<p>there you execute the following command
for unix :</p>

<pre><code>neko build.n -debug
</code></pre>

<p>for windows :</p>

<pre><code>neko build.n -debug -DABI=-MTd
</code></pre>

<p>the debug flag is not necessary but allow you to debug inside the Haxe std generated by hxcpp</p>

<p>One last thing I forgot to mention: you will need <a href="http://www.cmake.org/">cmake</a> as I use it to generate the platform specific project files for the C++ code</p>

<p>And this should be all for your environment setup</p>

<h1 id="the-demo:95526b837c261f1f491370c2a19f8b5a">The Demo</h1>

<p>Now you can grab the source code of the example at <a href="https://github.com/wighawag/hxcpp-test">https://github.com/wighawag/hxcpp-test</a>
As said earlier, it does not use my company&rsquo;s c++ engine but instead it use a simple setup where the main is not controlled by Haxe.</p>

<p>The cpp folder contains the &ldquo;engine code&rdquo; with the required haxe cpp code.
the src folder contains the haxe code that will generate the static library in the &ldquo;lib&rdquo; folder (which will be linked to the binary generated by the &ldquo;engine&rdquo;)</p>

<p>the build.hxml have some directive you might be interested in :</p>

<pre><code>-main Main #this is the main entry point of the static_library and its `static function main` will be executed first
-cpp lib # this is the folder to which the generated cpp and static library will be generated (named Main-debug.a/Main-debug.lib because of debug)
-cp src # this is the haxe source folder
-lib hxcpp # this is required to use hxcpp
-D static_link # as mentioned earlier this is required to generate a static library instead of an executable
-D ABI=-MTd # this is required on Windows. the &quot;d&quot; stand for debug
-debug # make it debug
</code></pre>

<p>You can compile your static lib via the following command :</p>

<pre><code>haxe build.hxml
</code></pre>

<p>Then for the c++ side we use cmake and for that I choose the following process (there might be better one):</p>

<p>go in the cpp folder and create a build folder there (for the cmake generated files)</p>

<pre><code>cd cpp
mkdir build
</code></pre>

<p>then go inside that build folder and execute cmake:</p>

<pre><code>cd build
cmake ..
</code></pre>

<p>This will generate your project file in the build folder
For windows it will generate by default Visual Studio solution (you will need to set HaxeTest as your startup project and then you can start debugging</p>

<h1 id="c-to-haxe:95526b837c261f1f491370c2a19f8b5a">C++ to Haxe</h1>

<p>Since we do not control the main entry point we need the C++ code to call haxe code. Since we have only one haxe app running we can use static function for that direction (C++ -&gt; Haxe). This map easily with the virtual function implementation of a main Abstract class.</p>

<p>Here we do not have an abstract class in C++ and instead we call directly the haxe generated cpp. You can see the main cpp code here :
<iframe width="100%" height="100%" src="http://script-iframe.appspot.com/script?url=http://gist-it.appspot.com/github/wighawag/hxcpp-test/blob/master/cpp/src/haxetest.cpp"><br /></iframe></p>

<p>In order to do that we need to add some haxe specific C++ code :</p>

<p>First we need to put some haxe initialization call in the c++ side :
This require some declaration as you can see in the code:</p>

<pre><code>extern &quot;C&quot; const char *hxRunLibrary();
extern &quot;C&quot; void hxcpp_set_top_of_stack();
</code></pre>

<p>then in the main we call these functions with checking for error:</p>

<pre><code>hxcpp_set_top_of_stack();
const char *err = hxRunLibrary();
if (err) {
  // Unhandled exceptions ...
  fprintf(stderr,&quot;Error %s\n&quot;, err );
  return -1;
}
</code></pre>

<p>This is pretty straight forward. in your engine if you do not control the main you can put it in your init function for example</p>

<p>The second thing to do is to declare the haxe App static function interface :</p>

<pre><code>class App_obj{
  public:
    static int init(int value);
    static int update(::cpp::Pointer&lt;Rectangle&gt; rect);
};
</code></pre>

<p>This directly map to the haxe class App defined as shown here :</p>

<iframe width="100%" height="100%" src="http://script-iframe.appspot.com/script?url=http://gist-it.appspot.com/github/wighawag/hxcpp-test/blob/master/src/App.hx"><br /></iframe>

<p>the following declaration allow you to define a specific instance which will be call for each static function</p>

<pre><code>public static var instance:AppInstance;
</code></pre>

<p>Then you just need to set the following as your main static function :</p>

<p>static public function main():Void{  App.instance = new Main(); }</p>

<p>Please note that hxcpp append <code>&quot;_obj&quot;</code> to every haxe class generated to cpp. That is why the declaration above mentioned <code>&quot;App_obj&quot;</code> and not just <code>&quot;App&quot;</code></p>

<p>Since in the App_obj declaration use the ::cpp::Pointer type we need to declare it as well :</p>

<pre><code>namespace cpp{
  template&lt;typename T&gt;
  class Pointer{
    public:
      T *ptr;
      inline Pointer(const T *inValue) : ptr((T*)inValue) { }
  };
}
</code></pre>

<p>There is more to this type but we just declare what we are using.</p>

<p>You might be wandering why do we need to duplicate the declaration that should already exist somewhere in the hxcpp generated cpp?
Actually in this particular example it might have worked but in the C++ engine I use, the hxcpp header were conflicting with some of the engine headers. I forgot the exact reason but it might be due to some shared typdef? So Instead I duplicate the headers that I need. This should not be much more that what I have here.</p>

<p>Once you have the declaration setup, you can make your call:</p>

<p>Here I did not bother to make a proper engine and i just call init() followed by update on only once but this should be pretty straightforward to extend:</p>

<pre><code>::App_obj::init(1);
::App_obj::update(::cpp::Pointer&lt;Rectangle&gt;(rect));
</code></pre>

<p>This is pretty much it for having your haxe code run from the c++ engine</p>

<h1 id="haxe-to-c:95526b837c261f1f491370c2a19f8b5a">Haxe to C++</h1>

<p>In order to go the other way (Haxe -&gt; C++) we can use the latest &ldquo;extern&rdquo; feature of hxcpp. This is far better than the old <a href="http://old.haxe.org/doc/cpp/ffi">cffi</a> which allowed only static function to be called. If you prefer though, you can still use it.</p>

<p>The way it works is similar to other targets except there is few gotchas.</p>

<p>You declare your extern as usual with some extera metadata:</p>

<pre><code>@:structAccess
@:include(&quot;Rectangle.h&quot;)
@:native(&quot;Rectangle&quot;)
extern class Rectangle{
    public function set_values(w : Int, h : Int) : Void;
    public function area() : Int;
}
</code></pre>

<p>@:structAccess need to be there so that hxcpp use the &ldquo;.&rdquo; operator instead of e the &ldquo;-&gt;&rdquo; operator</p>

<p>By the way, @:unreflective might be necessary in some case so hxcpp do not generate Dynamic access to the class. Do not need it here for Rectangle though.</p>

<p>the @:include metadata will inject the include directive in every cpp file generated that need  that extern.</p>

<p>the @:native tell hxcpp the name (including namespace if provided) of the class. Here it is require as the extern live in the &ldquo;engine&rdquo; package and without that hxcpp would add use a namespace &ldquo;engine&rdquo;</p>

<p>I also added an Include.hx file which add some information to hxcpp so it can find the header files included:</p>

<pre><code>@:buildXml(&quot;
&lt;files id='haxe'&gt;
  &lt;compilerflag value='-I../cpp/include'/&gt;
&lt;/files&gt;
&lt;files id='__lib__'&gt;
  &lt;compilerflag value='-I../cpp/include'/&gt;
&lt;/files&gt;
&quot;)
@:keep class Include{

}
</code></pre>

<p>both <code>haxe</code> and <code>__lib__</code> section are required. the <code>__lib__</code> is used as we compile it to a static library. I could not find documentation about it though.</p>

<p>the @:keep is to make sure the class is used (so that hxccp use its info) even if not declared anywhere.</p>

<p>Once you have the extern and the extra information for hxcpp you can use the class as an Haxe object.</p>

<p>Here I directly use the Rectangle header file but since some of my engine headers had conflict with hxcpp I had to duplicate the problematic header for hxcpp to know about the required type in a similar way than described in the c++ -&gt; haxe section. You might need to do that as well.</p>

<p>Another thing though is that you will probably want to pass pointers to haxe. In that case you will need the cpp.Pointer class and the corresponding ::cpp::Pointer, the same I use for the Rectangle instance that I pass to the update method.</p>

<p>With pointer you have to be careful as haxe do not modify the semantics of the cpp pointer. As such it modify Haxe semantic a bit:</p>

<p>When you have a cpp.Pointer in haxe code, if you access the value/ref member and store it in a variable. that variable will contain <strong>a copy</strong> of the value pointed by the pointer and not the reference. If you want to manipulate the object you have to alway use the ref inline. You can think of &ldquo;ref&rdquo; as the &ldquo;-&gt;&rdquo; of cpp.</p>

<p>If you take a look at App.hx you can see :</p>

<pre><code>rect.ref.set_values(4,200);
instance.update(rect.ref.area());
</code></pre>

<p>The ref is used so the actual rect is modified and its area method called apropriately.</p>

<p>hxcpp could probably improve on this. Or a macro could be done to generate some code to avoid the issue: it could generate an error on assigning ref to a variable for example.</p>

<p>To be clear the following will set values on a copy and thus the area passed to function will not be the expected one:</p>

<pre><code>var actualRect = rect.ref;
actualRect.set_values(4,200);
instance.update(rect.ref.area ());
</code></pre>

<h1 id="conclusion:95526b837c261f1f491370c2a19f8b5a">Conclusion</h1>

<p>There is probably a lot more to be said on the hxcpp extern integration but that would be all for now. If you knew already about cffi, I suppose this new extern facility should look like a big improvement. The integration process while not as seemless as flash/java target, it is not very hard neither. Maybe we could generate the extern from the header files directly. In any case, I hope you got some learning from reading and that you will deep into haxe/hxcpp to explore more. Thank you for reading. If you have any questions, do not hesitate to put a comment.</p>

                    </div>
                </section>
                
                <h1 class="content-subhead">31 Dec 2012, 16:26</h1>
                <section class="post">
                    <header class="post-header">

                        <a href="http://blog.wighawag.com/blog/2012/12/nme-stage3d-support/" class="post-title">NME Stage3D support</a>

                        <p class="post-meta">
                            
                            
                        </p>
                    </header>

                    <div class="post-description">
                        <p>Hi everybody, long time I did not write a post,</p>

<p>During that time I learnt a wonderful language, <a href="haxe.org">Haxe</a>. I have still lot to learn thought. I don&rsquo;t want to go in the details of why this language (or more accurately its ecosystem) is awesome but as an Actionscript developer for the last 3 years, there is no question to switch back. Haxe offer everything that actionscript has to offer (compiling to swf including air) + many extra feature</p>

<p>The ones I like the most are:</p>

<ul>
<li>Generics,</li>
<li>Typed function</li>
<li>and Macros (which I still have to practice more)</li>
</ul>

<p>I also like that the compiler is very fast (compared to mxmlc) and it handle Type inference, no need to repeat yourself like in actionscript</p>

<p>But the main advantage is that Haxe can compile to other languages. The current stable ones being swf, javascript, php, c++ and neko (a virtual machine that I did not use much except for writing tools and for using Macros (as they run on this virtual machine).</p>

<p>This not only means that you can get your code working on android, ios, blackberry, linux, mac os x, windows, webos but also that you can share code between client and server</p>

<p>If I find some time I would like to make a Python target myself but as of now this is unlikely to happen</p>

<p>The other great thing about Haxe is its community, they are doing a great job with Haxe itself (haxe 3 in the making) and with great libraries (<a href="http://www.nme.io/">NME</a>, <a href="https://github.com/aduros/flambe">Flambe</a>, <a href="https://github.com/jdonaldson/promhx">Promhx</a>,.,) and quick to reply to questions</p>

<p>Let&rsquo;s get back on the topic. I am writing this post to share the last work I did regarding Haxe and maybe this will contribute to the community..</p>

<p>I am currently working on a game engine which I plan to use for mobile game as well as web based game (thanks to Haxe of course :)</p>

<p>I have a renderer agnostic api and until the last few days I was using:</p>

<ul>
<li>Flambe 1.2 (only its rendering part) to render stuff on Flash (using stage3d and bitmap renderer as a fallback)</li>
<li>NME Tilesheet API for cpp target (testing only linux and android)</li>
</ul>

<p>Then I started to implement a tile map and as soon as I started to add many tiles, my old android phone (an HTC magic upgraded to androdi 2.3) could not display anything,</p>

<p>The reason was not Tilesheet performance (using GPU) per se but the fact that in order to update the position of the tiles while scrolling, the CPU (not the GPU) could not handle the many tile. Of course there were lots of optimization possible as I was using a quite high level API but this problem made me think that it would be nice if I could use the GPU myself directly so that I can save my vertex buffer at the beginning and at each frame I would just need to update the view matrix.
Actually maybe there was a nice way to achieve the same with tilesheet API ?</p>

<p>Anyway, just in time came NME 3.5.1 with support for OpenGLView</p>

<p>I jumped on it and learn OpenGL on the way to realize that it should not be too difficult to implement the Stage3D API for NME</p>

<p>So here it is <a href="https://github.com/wighawag/NME/tree/stage3d">https://github.com/wighawag/NME/tree/stage3d</a></p>

<p>It is still not fully working as flash Stage3D is. here is a partial list of the issues:</p>

<ul>
<li>there is no support for multiple textures yet</li>
<li>(Index/Vertex)Buffer can only be uploaded from ByteArray as of now (it might be straigthforward to make it work with Vector though)</li>
<li>for Context3D here are the following issues:</li>
<li>Context3D.setCulling is not tested</li>
<li>Context3D.setDepthTest not woking  (Currentlty the constants for the Depth test are not set in the opengl API provided in NME)</li>
<li>Context3D.configureBackBuffer does not take in consideration antiAlias and enableDepthAndStencil arguments</li>
<li>Context3D.createCubeTexture not implemented</li>
<li>Context3D.createTexture does not consider Format, optimizeForRenderToTexture and streamingLevels arguments</li>
<li>Context3D.drawToBitmapData not implemented</li>
<li>Context3D.setProgramConstantsFromByteArray not implemented</li>
<li>Context3D.setProgramConstantsFromVector not implemented</li>
<li>Context3D.setRenderToBackBuffer not implemented</li>
<li>Context3D.setRenderToTexture not implemented</li>
<li>Context3D.setScissorRectangle not implemented</li>
<li>Context3D.setStencilActions not implemented</li>
<li>Context3D.setStencilReferenceValue not implemented</li>
<li>probably many thing I forgot</li>
<li>since the openGL api used in NME does not allow direct call to render, you need to set a render function. This is achieved by passing a function to Contex3D.setRenderMethod (which does not exist in flash). To be as close as possible to flash Stage3D I should probably allow to render in Event.ENTER_FRAME or any timer. But this would require to cache the calls made to context3D and replay them when the openGL API call the render function.</li>
</ul>

<p>Anyway the main drawback currently is that since Stage3D and opengl use different shader language you still need to code your shader in two languages. Also regarding GLSL, since I wanted to use Stage3D api which does not support arbitrary name for attributes and uniforms, you have to use the same convention as AGAL (vc0, vc1 for vertex uniforms, va0, va1.. for vertex attribute, &hellip;etc&hellip;) as attribute and uniform name in GLSL</p>

<p>The best solution here would be to extend <a href="http://haxe.org/manual/hxsl">HXSL</a> and use it to have only one language for both Stage3D and GLSL but I did not look into that. I know there were some work on a GLSL target for HXSL but I don&rsquo;t know what is the state of this as of now, Any info ?</p>

<p>I will porbably look into it when I ll need more complex shader stuff.</p>

<p>I plan to continue working on this Stage3D port and I would be very glad if it could be included in NME trunk so my work do not get lost as a patch file.  I ll probably do a pull request even if it s still not perfect)</p>

<p>I posted a test here  <a href="https://github.com/wighawag/NMEStage3DTest">https://github.com/wighawag/NMEStage3DTest</a></p>

<iframe width="500" height="500" src="http://www.wighawag.com/blog/content/NMEStage3DTest.html"></iframe>

<p>It should work in Flash without my new version of NME
And the patch provided <a href="https://raw.github.com/wighawag/NMEStage3DTest/master/stage3d.patch">here</a> should make it work in cpp (tested only on Linux 64 bit by the way)</p>

<p>You ban also clone my NME fork if you prefer and checkout the &ldquo;stage3d&rdquo; branch</p>

<p>Let me know what you think and if some of you already started some similar work, let&rsquo;s cooperate.</p>

<p>All the best for the coming new year!</p>

<p>We survived the end of the world so let&rsquo;s celebrate apropriately :)</p>

                    </div>
                </section>
                
                <h1 class="content-subhead">05 Jun 2011, 16:26</h1>
                <section class="post">
                    <header class="post-header">

                        <a href="http://blog.wighawag.com/blog/2011/06/profiler-injection-with-mixingloom-as3commons-bytecode-and-flash-preloader/" class="post-title">Profiler Injection With MixingLoom as3commons bytecode and Flash Preloader</a>

                        <p class="post-meta">
                            
                            
                        </p>
                    </header>

                    <div class="post-description">
                        

<h3 id="introduction:7f7dc6812c7bbeec4c326bca656ef8ab">Introduction</h3>

<p>Recently I discovered <strong>MixingLoom</strong> through <a href="http://www.jamesward.com/2011/04/26/introducing-mixing-loom-runtime-actionscript-bytecode-modification/">James Ward&rsquo;s article</a>, it is a library to ease the injection of code in swf. One usage of it is <a href="http://en.wikipedia.org/wiki/Aspect-oriented_programming">Aspect Oriented Programming</a> to separate logging, analytics&hellip; from the actual application code by injecting the extra code (logging, analytics&hellip;)  into the swf after compilation (thanks to <a href="http://www.as3commons.org/as3-commons-bytecode/index.html">as3commons-bytecode library</a> ). This way the extra code does not appear anywhere in the application source code which stay focused on what it should do.</p>

<p>Here I ll show you how to inject profiler code to measure the speed of execution of particular functions. An xml file read at run time would be used to specify which function to profile (and to inject). It can be used for other purpose as well but since currently it does not handle arguments except for 1 string argument, it is quite limited.</p>

<h3 id="preloader:7f7dc6812c7bbeec4c326bca656ef8ab">Preloader</h3>

<p>Since I did not want to use flex at all, I could not use the example in James&rsquo; article which use the MixingLoom flex preloaders.</p>

<p>Instead I used the built-in flash preloader, the one you specify through mm.config property (see <a href="http://jpauclair.net/2010/02/17/one-swf-to-rule-them-all-the-almighty-preloadswf/">here</a> and <a href="http://philippe.elsass.me/2010/09/as3-hacking-preloadswf-for-fun-and-profit/">here</a> ) it is a preloader preloaded by flash itself before anything is loaded. It allows us to execute code at the point where the main class is loaded.</p>

<p>This basically allow injection of code to any swf (whether it has been compiled by you or not). I had  some problem though making the profiler injection work when the swf is compiled in release mode. (see that later)</p>

<p>here is the preloader abstract class I use :</p>

<iframe width="100%" height="100%" src="http://script-iframe.appspot.com/script?url=http://gist-it.appspot.com/github/wighawag/mixingloom-profiler/raw/master/src/com/wighawag/preloader/AS3AbstractPreloader.as"><br /></iframe>

<p>This abstract preloader need to be extended so that it is able to inject code into the application code. This can done by overriding  <strong>applyModifications</strong>  and then call <strong>modificationsApplied</strong> with the modified loaded bytes</p>

<p><strong>modificationsApplied</strong> receive an event containing the modified application (the event can come directly from MixingLoom ModifiedByteLoader or PatcherApplierImpl (who reload the modified byte into flash).</p>

<p>The abstract preloader then add it to the stage.</p>

<p>In fact the abstract preloader will also remove everything from the stage so that it start clean and does not have two application running at the same time.</p>

<p>Unfortunately, in many applications (since in most case, the main class is not supposed to be removed from stage) the main class has event listener registered with the stage which are not automatically removed when the main instance is removed from the stage. Because of that even if the main class is removed from stage the listener will keep the main class instance in memory and will be executed.</p>

<p>If you are the author of the application, you can simply unregister listener on REMOVED_FROM_STAGE event.</p>

<p>If you have no control over the code, then I do not know the solution, except maybe by analysing the swf bytecode to find listerner registration (a probably complex task) and unregister them.</p>

<p>The problem come from the built-in preloader : as soon as the main application is loaded it is instantiated and added to stage. It seems we do not have a hook before that happened.</p>

<p>If anyone has a solution for it let me know.</p>

<p>Note : This abstract preloader can be extended for any purpose including non-mixingloom/injection one</p>

<h3 id="setting-up-mixingloom:7f7dc6812c7bbeec4c326bca656ef8ab">Setting up MixingLoom</h3>

<p>Apart from having to re-hook the preloading part I also had to deal with the patchers and byte injection myself. Indeed James in his article use MixingLoom preloader which take care of applying the patch specified on the constructor through the flex specific code.</p>

<p>Thanks to MixingLoom it is just a matter of instantiating an IPatcherApplier and passing a vector of patchers</p>

<p>And thanks to the abstract preloader, I just needed to override <strong>applyModifications</strong> and call <strong>modificationsApplied</strong> when the patchers are applied (by setting the applier callback)</p>

<p>I created another abstract preloader extending the preceding one to deal specifically with patchers and applier:</p>

<iframe width="100%" height="100%" src="http://script-iframe.appspot.com/script?url=http://gist-it.appspot.com/github/wighawag/mixingloom-profiler/raw/master/src/com/wighawag/preloader/AS3AbstractPatcherPreloader.as"><br /></iframe>

<p>It just instantiate an PatcherApplierImp and override <strong>applyModifications</strong> to save the bytes that need to be modified and then expect its subclass to call <strong>applyPatchers</strong> with a list of patchers passed as argument</p>

<p>The <strong>applyPatchers</strong>  then add the list of patchers to the applier and set <strong>modificationsApplied</strong> to be the callback of the applier. The applier is then applied.</p>

<p>To extend the abstract class, the only neccessary bit is then to call <strong>applyPatchers</strong> with a list of patchers.</p>

<h3 id="injection:7f7dc6812c7bbeec4c326bca656ef8ab">Injection</h3>

<p>Now that we have all the framework in place we can see an actual implementation of these abstract classes:</p>

<iframe width="100%" height="100%" src="http://script-iframe.appspot.com/script?url=http://gist-it.appspot.com/github/wighawag/mixingloom-profiler/raw/master/src/MixingLoomAS3Preloader.as"><br /></iframe>

<p>As you can see instead of dealing with xml loading in the patchers (as in Jame&rsquo;s example) I deal with them outside. This allow the patchers to focus on their actual work and also allow me to deal with loading failure directly in the preloader without requiring the patchers to tell us what happened.</p>

<p>on success the patchers are instantiated with the xml data and <strong>applyPatchers</strong> is called</p>

<p>on failure the patchers are not applied and it show an error message.</p>

<p>In both case I then add a console to the stage (in <strong>xmlFailed</strong> or <strong>modificationApplied</strong>). This <a href="http://code.google.com/p/flash-console/">flash-console</a> is very useful to see what is going on and will allow us here to see the profiling results. It also allow to execute code dynamically through a command line interface. check it out.</p>

<p>If you noticed I imported com.wighawag.profiler.TimeProfiler but it is not used. I referenced it directly so that it is imported in the final swf.</p>

<p>This way I make sure I have this class compiled in when it is used by the injection.
Basically for each class method you want to inject you need it to be compiled in either in the preloader or in the swf target of the injection. In this project case I did not want the profiler to be part of the targeted swf instead I wanted the targeted swf to be clean of any profiling code or libraries.</p>

<p>Now let&rsquo;s discuss the actual patcher : <strong>MethodCallWrapperPatcher</strong></p>

<p>The class is here:</p>

<iframe width="100%" height="100%" src="http://script-iframe.appspot.com/script?url=http://gist-it.appspot.com/github/wighawag/mixingloom-profiler/raw/master/src/com/wighawag/injection/patcher/MethodCallWrapperPatcher.as"><br /></iframe>

<p>its constructor expect xml data (not a url since it does not deal with loading). This xml data specify which method to inject and where</p>

<p>the apply function is the main method and looks quite similar to the SampleXMLPatcher of James except that it look for every tag (making it slower but make it potentially work for realeased swf)</p>

<p>Then for each class and for each of their instance it look whether their instance are specified as targets in the xml.
If so, it inject the source classes&rsquo; methods (so in this case it will inject the <strong>com.wighawag.profiler.TimeProfiler</strong> methods &ldquo;start&rdquo; and &ldquo;finish&rdquo; )</p>

<p>to do the actual injection I use <strong>MethodCallWrapper</strong> which can inject one method at the beginning of a method body and another method at the end (before every return)</p>

<p>Like this it can profile the time it takes to execute the function.</p>

<p>this methodCallWrapper takes two MethodCall which a list of argument <strong>(currently only string arguments are accepted and only the first one will be taken in account)</strong></p>

<p>Here is the code:</p>

<iframe width="100%" height="100%" src="http://script-iframe.appspot.com/script?url=http://gist-it.appspot.com/github/wighawag/mixingloom-profiler/raw/master/src/com/wighawag/injection/injector/MethodCallWrapper.as"><br /></iframe>

<p>As you can see it follows the same template as the MixingLoom example: it does not change the byte before the pushscope opcode.</p>

<p>then it inject the first  MethodCall with the argument being the function being injected (so that the profile function knwo which function is beign measured)</p>

<p>Then it incrase the maxStack value so that even if the next method call is between a push opcode and a return opcode, the push opcode created by the method call will not exceed the maxStack (if it does, the flash player throw a Verify Error).
It is probably possible instead of injecting the methodcall just before the return to detect where the last push opcode (used by the return opcode) is located and inject the methodcall just before it but it was easier to just increase the maxStack.</p>

<p>then for each return opcode, it inject the second MethodCall and return the position in the method body after injection so that we can chain injections</p>

<p>The MethodCall injector is as follow:</p>

<iframe width="100%" height="100%" src="http://script-iframe.appspot.com/script?url=http://gist-it.appspot.com/github/wighawag/mixingloom-profiler/raw/master/src/com/wighawag/injection/injector/MethodCall.as"><br /></iframe>

<p>It is similar to the MixingLoom method call injection except that it adds a string argument through a pushstring opcode</p>

<p>Again, after injecting it returns the position after the injection.</p>

<p>That&rsquo;s it. Normally it should work with application compiled in release mode but I get the error : <strong>Cpool index 0 is out of range 47.</strong> when the method call execute.
If I do not add the string as argument to the call, it execute fine.
I checked the as3commons-bytecode code and it correctly add the string to the constant pool so I do not know what is wrong. any ideas?</p>

<p>In debug everything is fine</p>

<p>the code is located at <a href="https://github.com/wighawag/mixingloom-profiler">github</a>
By the way, since the code shown in this page is dynamically taken from the github code, it is up to date</p>

<p>To show it works I created an example project at <a href="https://github.com/wighawag/mixingloom-profiler-example">github</a></p>

<iframe width="100%" height="100%" src="http://www.wighawag.com/blog/content/mixingloomprofilerexample.swf"></iframe>

<p>it has 4 button and 4 numeric stepper (from  <a href="https://github.com/wighawag/minimalcomps">minimalcomps</a>, actually a fork since there is issues with instance variables set at the class level , _maximum and _minimum in this case. I did not have time to investigate but it made me think that using mm.config preloader is not a very good idea even if it theorically allow you to profile any swf on the net.</p>

<p>the first button execute a recursive implementation of fibonacci for the value specified in the numeric stepper
By adding the path to the method in the xml, you ll see how long it takes to compute it in the console.</p>

<p>The second button execute an non-recursive implementation of fibonacci. It is also profiled assuming you use the provided injection xml.</p>

<p>the third and fourth button are not meant to be profiled since a wrapper function already profile it.
The time is shown next to the steppers. This allow  to see how the profiling injection affect the execution speed of the function injected.</p>

<p>you can download the compiled profiler <a href="/blog/content/MixingloomPreloader.swf">here</a></p>

<p>To see the profiling at work you need to edit your mm.config (see here) so that the flash preload your profiler</p>

<p>for example if the preloader has been downloaded in C:/Applications (you also need to add this path to the the trusted locations in <a href="http://www.macromedia.com/support/documentation/en/flashplayer/help/settings_manager04.html">flash config</a>)</p>

<p>you can use</p>

<pre><code>PreloadSwf=C:/Applications/MixingLoomPreloader.swf?xmlUrl=methodCallWrapperInjections.xml
</code></pre>

<p>the file <strong>methodCallWrapperInjections.xml</strong> is located in the bin fodler to which the url is relative:</p>

<iframe width="100%" height="100%" src="http://script-iframe.appspot.com/script?url=http://gist-it.appspot.com/github/wighawag/mixingloom-profiler-example/raw/master/bin/methodCallWrapperInjections.xml"><br /></iframe>

<p>it specify which function to profile including the fibonacci methods</p>

<p>You may have to download the <a href="/blog/content/mixingloomprofilerexample.swf">targeted swf</a> to make it work and launch it directly (not sure if it works with browsers by default for example, I could not make it work with chrome)</p>

<p>And as you can see, the recursive fibonacci already slow in flash is even more slower with the profiling enabled. This is because the profiling function is called for each recursion and function call in flash is slow.</p>

<p>the code:</p>

<iframe width="100%" height="100%" src="http://script-iframe.appspot.com/script?url=http://gist-it.appspot.com/github/wighawag/mixingloom-profiler-example/raw/master/src/Main.as"><br /></iframe>

<p>The post have been longer (both in time to write and text length) than I thought and I hope it is clear enough.</p>

<p>Thank you for reading! Do not hesitate to leave comments</p>

                    </div>
                </section>
                
            </div>
            

            <div class="footer">
    <div class="pure-menu pure-menu-horizontal pure-menu-open">
        <ul>
            <li>Powered by <a class="hugo" href="http://hugo.spf13.com/" target="_blank">hugo</a></li>
        </ul>
    </div>
</div>
<script src="http://blog.wighawag.com//js/all.min.js"></script>
        </div>
    </div>
</div>


<script>
(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
})(window,document,'script','//www.google-analytics.com/analytics.js','ga');

ga('create', '', 'auto');
ga('send', 'pageview');

</script>

</body>
</html>
